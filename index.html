<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <p id="username"></p>

    <div id="posts">

    </div>
</body>

<script>

function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        });
    return result;
}


function getUsername(token, id){
    let request = new XMLHttpRequest()
    request.open("GET", `https://graph.instagram.com/${id}?fields=id,username&access_token=${token}`, true)
    request.onreadystatechange = () => {
        if(request.readyState === XMLHttpRequest.DONE) {
            
            if (request.status === 0 || (request.status >= 200 && request.status < 400)) {

                return JSON.parse(request.responseText).username

            } else {
                console.log("error getting user name");
            }
        }
    }
    request.send()
}

function getPosts(token){
    let request = new XMLHttpRequest()
    request.open("GET", `https://graph.instagram.com/me/media?fields=id,caption&access_token=${token}`, true)

    request.onreadystatechange = () => {
        if(request.readyState === XMLHttpRequest.DONE) {
            if (request.status === 0 || (request.status >= 200 && request.status < 400)) {
                alert(JSON.parse(request.responseText))
                return JSON.parse(request.responseText)

            } else {
                console.log("error getting user name");
            }
        }
    }
    request.send()
}

function loadPost(id , token){
    let request = new XMLHttpRequest()
    request.open("GET", `https://graph.instagram.com/${id}?fields=id,media_type,media_url,username,timestamp&access_token=${token}`, true)
    
    request.onreadystatechange = () => {
        if(request.readyState === XMLHttpRequest.DONE) {
            
            if (request.status === 0 || (request.status >= 200 && request.status < 400)) {
                var image = JSON.parse(request.responseText).media_url
                document.body.innerHTML += `<img src="${image}">`
            } else {
                console.log("error getting user name");
            }
        }
    }

    request.send()
}

function getAccessToken(Code){
    let request = new XMLHttpRequest()
    request.open("POST", "https://api.instagram.com/oauth/access_token", false)


    request.onload = () => {
        if(request.readyState === XMLHttpRequest.DONE) {
            alert(`${request.status} : ${request.responseText}`)
            if (request.status === 0 || (request.status >= 200 && request.status < 400)) {

                alert(`inside  ${JSON.parse(request.responseText).access_token}`)
                return JSON.parse(request.responseText);
                
                
            } else {
                console.log("error getting access token");
            }
        }
    }

    let data = new FormData()
    data.append("client_id", "1075169123005158")
    data.append("client_secret", "5eebcfbda6e50f65f9efbd06b0518064")
    data.append("grant_type", "authorization_code")
    data.append("redirect_uri", "https://kkgv1.github.io/ubiquitous-goggles/")
    data.append("code", Code)

    request.send(data)

 
}

// try{
    var code = findGetParameter("code")
    var token = getAccessToken(code)
    alert(` out ${JSON.parse(token).access_token}`)

    var accessToken = token.access_token
    var userid = token.userid

    var username = getUsername(accessToken , userid)
    var postslist = getPosts(accessToken)
    
    document.getElementById("username").innerHTML = username

    for(i of postslist){
        document.getElementById("posts").innerHTML += `<p onclick="loadPost(${i.id}, ${token})">${i.id}</p> \n <p>${i.caption}</p> \n`
    }
// }catch{
//     alert("error")
// }


    
    

</script>
</html>
